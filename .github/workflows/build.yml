name: Build OpenCPN Plugin

on:
  push:
    branches:
      - '*'
      - '!devel'
      - '!tmp'
    tags:
      - '*'
  pull_request:
    branches:
      - '*'

env:
  CLOUDSMITH_USER: opencpn
  USE_UNSTABLE_REPO: OFF

  # Whether a single build is started can be controlled via the repository variable BUILD_CONFIG, which must look like this:
  # {"BUILD_ANDROID_ARM64":true,"BUILD_ANDROID_ARMHF":true,"BUILD_MACOS_UNIVERSAL":true,"BUILD_MSVC_WX32_2022":true,"BUILD_FLATPAK_AARCH64_2208":true,"BUILD_FLATPAK_X86_2208":true,"BUILD_FLATPAK_AARCH64_2408":true,"BUILD_FLATPAK_X86_2408":true,"BUILD_DEBIAN_X86_64_13_TRIXIE":true,"BUILD_DEBIAN_ARM64_13_TRIXIE":true,"BUILD_DEBIAN_ARMHF_13_TRIXIE":true,"BUILD_DEBIAN_X86_64_12_BOOKWORM":true,"BUILD_DEBIAN_ARM64_12_BOOKWORM":true,"BUILD_DEBIAN_ARMHF_12_BOOKWORM":true,"BUILD_DEBIAN_X86_64_11_BULLSEYE":false,"BUILD_DEBIAN_ARM64_11_BULLSEYE":false,"BUILD_DEBIAN_ARMHF_11_BULLSEYE":false,"BUILD_UBUNTU_X86_64_2204_JAMMY":true}
  # If the repository variable does not exist all builds will be executed.

jobs:
# =============================================================================
# Android Builds
# =============================================================================
  build-android-arm64:
    if: ${{ !vars.BUILD_CONFIG || fromJson(vars.BUILD_CONFIG).BUILD_ANDROID_ARM64 != false }}
    runs-on: ubuntu-latest
    container:
      image: cimg/android:2023.12-ndk
    env:
      OCPN_TARGET: android-arm64
      CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build Android ARM64
        shell: bash
        run: |
          chmod a+x github/*.sh
          bash github/github-build-android-arm64.sh

      - name: Deploy to Cloudsmith
        uses: ./.github/actions/deploy-cloudsmith

  build-android-armhf:
    if: ${{ !vars.BUILD_CONFIG || fromJson(vars.BUILD_CONFIG).BUILD_ANDROID_ARMHF != false }}
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: android-armhf
      CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
  
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip wget
  
      - name: Install Android NDK r21e (required for ARMHF)
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r21e-linux-x86_64.zip
          unzip android-ndk-r21e-linux-x86_64.zip
          sudo mv android-ndk-r21e /opt/android-ndk
          sudo mkdir -p /opt/android
          sudo ln -s /opt/android-ndk /opt/android/ndk
          echo "ANDROID_NDK_HOME=/opt/android-ndk" >> $GITHUB_ENV
          echo "ANDROID_NDK=/opt/android-ndk" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=/opt/android-ndk" >> $GITHUB_ENV
 
      - name: Build Android ARMHF
        run: |
          chmod a+x github/*.sh
          bash github/github-build-android-armhf.sh
  
      - name: Deploy to Cloudsmith
        uses: ./.github/actions/deploy-cloudsmith

# =============================================================================
# macOS Build
# =============================================================================
  build-macos-universal:
    if: ${{ !vars.BUILD_CONFIG || fromJson(vars.BUILD_CONFIG).BUILD_MACOS_UNIVERSAL != false }}
    runs-on: macos-14
    env:
      OCPN_TARGET: macos
      PKG_TARGET_WX_VER: "32"
      CMAKE_BUILD_PARALLEL_LEVEL: 2
      WX_VER: 32
      MACOSX_DEPLOYMENT_TARGET: '10.10'
      CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            /tmp/local.cache.tar
            cache
          key: macos-deps-${{ hashFiles('build-deps/macos-cache-stamp', 'cmake/MacosWxwidgets.cmake', 'ci/circleci-build-macos-universal.sh') }}
          restore-keys: |
            macos-deps-

      - name: Build macOS Universal
        run: |
          chmod a+x ci/*.sh
          chmod a+x cmake/*.sh
          ci/circleci-build-macos-universal.sh

      - name: Deploy to Cloudsmith
        uses: ./.github/actions/deploy-cloudsmith

# =============================================================================
# Windows MSVC Build
# =============================================================================
  build-msvc-wx32-2022:
    if: ${{ !vars.BUILD_CONFIG || fromJson(vars.BUILD_CONFIG).BUILD_MSVC_WX32_2022 != false }}
    runs-on: windows-2022
    env:
      OCPN_TARGET: MSVC
      PKG_TARGET_WX_VER: "32"
      MSVC_VERSION: 2022
      WX_VER: 32
      CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build MSVC
        shell: cmd
        run: ci\circleci-build-msvc.bat

      - name: Deploy to Cloudsmith
        uses: ./.github/actions/deploy-cloudsmith

# =============================================================================
# Flatpak Builds
# =============================================================================
  build-flatpak-aarch64-2208:
    if: ${{ !vars.BUILD_CONFIG || fromJson(vars.BUILD_CONFIG).BUILD_FLATPAK_AARCH64_2208 != false }}
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: flatpak
      BUILD_ARCH: aarch64
      FLATPAK_BRANCH: stable
      CLOUDSMITH_PKG_EXT: gz
      SDK_VER: 22.08
      CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
 
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
 
      - name: Build Flatpak ARM64
        run: |
          chmod a+x ci/*.sh
          bash ci/circleci-build-flatpak.sh

      - name: Deploy to Cloudsmith
        uses: ./.github/actions/deploy-cloudsmith

  build-flatpak-x86-2208:
    if: ${{ !vars.BUILD_CONFIG || fromJson(vars.BUILD_CONFIG).BUILD_FLATPAK_X86_2208 != false }}
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: flatpak
      BUILD_ARCH: x86_64
      FLATPAK_BRANCH: stable
      CLOUDSMITH_PKG_EXT: gz
      SDK_VER: 22.08
      WX_VER: 32
      CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Install Flatpak dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bubblewrap flatpak flatpak-builder
     
      - name: Build Flatpak x86_64
        run: |
          chmod a+x ci/*.sh
          bash ci/circleci-build-flatpak.sh
  
      - name: Deploy to Cloudsmith
        uses: ./.github/actions/deploy-cloudsmith

  build-flatpak-aarch64-2408:
    if: ${{ !vars.BUILD_CONFIG || fromJson(vars.BUILD_CONFIG).BUILD_FLATPAK_AARCH64_2408 != false }}
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: flatpak
      BUILD_ARCH: aarch64
      FLATPAK_BRANCH: stable
      CLOUDSMITH_PKG_EXT: gz
      SDK_VER: 24.08
      CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
  
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
  
      - name: Build Flatpak ARM64
        run: |
          chmod a+x ci/*.sh
          bash ci/circleci-build-flatpak.sh
  
      - name: Deploy to Cloudsmith
        uses: ./.github/actions/deploy-cloudsmith

  build-flatpak-x86-2408:
    if: ${{ !vars.BUILD_CONFIG || fromJson(vars.BUILD_CONFIG).BUILD_FLATPAK_X86_2408 != false }}
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: flatpak
      BUILD_ARCH: x86_64
      FLATPAK_BRANCH: stable
      CLOUDSMITH_PKG_EXT: gz
      SDK_VER: 24.08
      CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build Flatpak x86_64
        run: |
          chmod a+x ci/*.sh
          bash ci/circleci-build-flatpak.sh

      - name: Deploy to Cloudsmith
        uses: ./.github/actions/deploy-cloudsmith

# =============================================================================
# Debian Builds
# =============================================================================
  build-debian-x86_64-13-trixie:
    if: ${{ !vars.BUILD_CONFIG || fromJson(vars.BUILD_CONFIG).BUILD_DEBIAN_X86_64_13_TRIXIE != false }}
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: trixie
      BUILD_ARCH: amd64
      BUILD_GTK3: true
      WX_VER: 32
      BUILD_ENV: debian
      DOCKER_IMAGE: debian:trixie
      CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
 
      - name: Build Debian Trixie x86_64
        run: |
          chmod a+x github/*.sh
          github/github-build-ubuntu-docker.sh
 
      - name: Deploy to Cloudsmith
        uses: ./.github/actions/deploy-cloudsmith
 
  build-debian-arm64-13-trixie:
    if: ${{ !vars.BUILD_CONFIG || fromJson(vars.BUILD_CONFIG).BUILD_DEBIAN_ARM64_13_TRIXIE != false }}
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: trixie-arm64
      BUILD_ARCH: arm64
      DOCKER_IMAGE: arm64v8/debian:trixie
      BUILD_FLAGS: -j3
      BUILD_ENV: debian
      WX_VER: 32
      BUILD_GTK3: true
      USE_UNSTABLE_REPO: ON
      CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
          
      - name: Build Debian Trixie ARM64
        run: |
          chmod a+x github/*.sh
          github/github-build-ubuntu-docker.sh
          
      - name: Deploy to Cloudsmith
        uses: ./.github/actions/deploy-cloudsmith

  build-debian-armhf-13-trixie:
    if: ${{ !vars.BUILD_CONFIG || fromJson(vars.BUILD_CONFIG).BUILD_DEBIAN_ARMHF_13_TRIXIE != false }}
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: trixie-armhf
      BUILD_ARCH: armhf
      DOCKER_IMAGE: arm32v7/debian:trixie
      BUILD_FLAGS: -j3
      BUILD_ENV: debian
      WX_VER: 32
      BUILD_GTK3: true
      CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm

      - name: Build Debian Trixie ARMHF
        run: |
          chmod a+x github/*.sh
          github/github-build-ubuntu-docker.sh

      - name: Deploy to Cloudsmith
        uses: ./.github/actions/deploy-cloudsmith

  build-debian-x86_64-12-bookworm:
    if: ${{ !vars.BUILD_CONFIG || fromJson(vars.BUILD_CONFIG).BUILD_DEBIAN_X86_64_12_BOOKWORM != false }}
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: bookworm
      BUILD_ARCH: amd64
      BUILD_GTK3: true
      WX_VER: 32
      BUILD_ENV: debian
      DOCKER_IMAGE: debian:bookworm
      CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build Debian Bookworm x86_64
        run: |
          chmod a+x github/*.sh
          github/github-build-ubuntu-docker.sh

      - name: Deploy to Cloudsmith
        uses: ./.github/actions/deploy-cloudsmith

  build-debian-arm64-12-bookworm:
    if: ${{ !vars.BUILD_CONFIG || fromJson(vars.BUILD_CONFIG).BUILD_DEBIAN_ARM64_12_BOOKWORM != false }}
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: bookworm-arm64
      BUILD_ARCH: arm64
      DOCKER_IMAGE: arm64v8/debian:bookworm
      BUILD_FLAGS: -j3
      BUILD_ENV: debian
      WX_VER: 32
      BUILD_GTK3: true
      CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build Debian Bookworm ARM64
        run: |
          chmod a+x github/*.sh
          github/github-build-ubuntu-docker.sh

      - name: Deploy to Cloudsmith
        uses: ./.github/actions/deploy-cloudsmith

  build-debian-armhf-12-bookworm:
    if: ${{ !vars.BUILD_CONFIG || fromJson(vars.BUILD_CONFIG).BUILD_DEBIAN_ARMHF_12_BOOKWORM != false }}
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: bookworm-armhf
      BUILD_ARCH: armhf
      DOCKER_IMAGE: arm32v7/debian:bookworm
      BUILD_FLAGS: -j3
      BUILD_ENV: debian
      WX_VER: 32
      BUILD_GTK3: true
      CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm

      - name: Build Debian Bookworm ARMHF
        run: |
          chmod a+x github/*.sh
          github/github-build-ubuntu-docker.sh

      - name: Deploy to Cloudsmith
        uses: ./.github/actions/deploy-cloudsmith

  build-debian-x86_64-11-bullseye:
    if: ${{ !vars.BUILD_CONFIG || fromJson(vars.BUILD_CONFIG).BUILD_DEBIAN_X86_64_11_BULLSEYE != false }}
    runs-on: ubuntu-22.04
    container:
      image: buildpack-deps:bullseye-scm
    env:
      OCPN_TARGET: bullseye
      BUILD_ARCH: amd64
      BUILD_GTK3: true
      BUILD_ENV: debian
      CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup apt sources
        run: |
          echo "deb-src http://ftp.us.debian.org/debian bullseye main" | tee -a /etc/apt/sources.list
          echo "deb-src http://ftp.us.debian.org/debian bullseye-updates main" | tee -a /etc/apt/sources.list

      - name: Build Debian Bullseye x86_64
        run: |
          chmod a+x github/*.sh
          github/github-build-ubuntu-docker.sh

      - name: Deploy to Cloudsmith
        uses: ./.github/actions/deploy-cloudsmith

  build-debian-arm64-11-bullseye:
    if: ${{ !vars.BUILD_CONFIG || fromJson(vars.BUILD_CONFIG).BUILD_DEBIAN_ARM64_11_BULLSEYE != false }}
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: bullseye-arm64
      BUILD_ARCH: arm64
      DOCKER_IMAGE: arm64v8/debian:bullseye-backports
      BUILD_FLAGS: -j3
      BUILD_ENV: debian
      BUILD_GTK3: true
      CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build Debian Bullseye ARM64
        run: |
          chmod a+x github/*.sh
          github/github-build-ubuntu-docker.sh

      - name: Deploy to Cloudsmith
        uses: ./.github/actions/deploy-cloudsmith

  build-debian-armhf-11-bullseye:
    if: ${{ !vars.BUILD_CONFIG || fromJson(vars.BUILD_CONFIG).BUILD_DEBIAN_ARMHF_11_BULLSEYE != false }}
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: bullseye-armhf
      BUILD_ARCH: armhf
      DOCKER_IMAGE: jongough/debian-armhf:bullseye
      BUILD_FLAGS: -j3
      BUILD_ENV: debian
      BUILD_GTK3: true
      CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm

      - name: Build Debian Bullseye ARMHF
        run: |
          chmod a+x github/*.sh
          github/github-build-ubuntu-docker.sh

      - name: Deploy to Cloudsmith
        uses: ./.github/actions/deploy-cloudsmith

# =============================================================================
# Ubuntu Builds
# =============================================================================
  build-ubuntu-x86_64-2204-jammy:
    if: ${{ !vars.BUILD_CONFIG || fromJson(vars.BUILD_CONFIG).BUILD_UBUNTU_X86_64_2204_JAMMY != false }}
    runs-on: ubuntu-22.04
    env:
      BUILD_GTK3: true
      OCPN_TARGET: jammy
      WX_VER: 32
      BUILD_ENV: ubuntu
      CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Update apt sources
        run: |
          echo "deb-src http://us.archive.ubuntu.com/ubuntu/ jammy main" | sudo tee -a /etc/apt/sources.list
          echo "deb-src http://us.archive.ubuntu.com/ubuntu/ jammy-updates main" | sudo tee -a /etc/apt/sources.list
          echo "deb [trusted=yes] https://ppa.launchpadcontent.net/opencpn/opencpn/ubuntu/ jammy main" | sudo tee -a /etc/apt/sources.list
          sudo apt-get update

      - name: Build Ubuntu Jammy x86_64
        run: |
          chmod a+x ci/*.sh
          ci/circleci-build-debian.sh

      - name: Deploy to Cloudsmith
        uses: ./.github/actions/deploy-cloudsmith
