name: Build OpenCPN Plugin

on:
  push:
    branches:
      - '*'
      - '!devel'
      - '!tmp'
    tags:
      - '*'
  pull_request:
    branches:
      - '*'
  workflow_dispatch:

env:
  CLOUDSMITH_USER: opencpn
  USE_UNSTABLE_REPO: OFF

jobs:

# =============================================================================
# Android Builds
# =============================================================================
# build-android-arm64:
#   runs-on: ubuntu-latest
#   container:
#     image: cimg/android:2023.12-ndk
#   env:
#     OCPN_TARGET: android-arm64
#   steps:
#     - name: Checkout code
#       uses: actions/checkout@v4
#       with:
#         submodules: recursive
#
#     - name: Build Android ARM64
#       shell: bash
#       run: |
#         chmod a+x github/*.sh
#         bash github/github-build-android-arm64.sh
#
#     - name: Upload artifacts
#       uses: actions/upload-artifact@v4
#       with:
#         name: android-arm64-package
#         path: build/*.tar.gz
#         if-no-files-found: warn
#
#     - name: Deploy to Cloudsmith
#       if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
#       env:
#         CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
#         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#       run: |
#         sudo apt-get update
#         sudo apt-get install -y python3-pip 
#         python3 -m pip install cloudsmith-cli
#         bash ci/cloudsmith-upload.sh
#
# build-android-armhf:
#   runs-on: ubuntu-latest
#   env:
#     OCPN_TARGET: android-armhf
#   steps:
#     - name: Checkout code
#       uses: actions/checkout@v4
#       with:
#         submodules: recursive
# 
#     - name: Install dependencies
#       run: |
#         sudo apt-get update
#         sudo apt-get install -y unzip wget
# 
#     - name: Install Android NDK r21e (required for ARMHF)
#       run: |
#         wget https://dl.google.com/android/repository/android-ndk-r21e-linux-x86_64.zip
#         unzip android-ndk-r21e-linux-x86_64.zip
#         sudo mv android-ndk-r21e /opt/android-ndk
# 
#         sudo mkdir -p /opt/android
#         sudo ln -s /opt/android-ndk /opt/android/ndk
# 
#         echo "ANDROID_NDK_HOME=/opt/android-ndk" >> $GITHUB_ENV
#         echo "ANDROID_NDK=/opt/android-ndk" >> $GITHUB_ENV
#         echo "ANDROID_NDK_ROOT=/opt/android-ndk" >> $GITHUB_ENV
#
#     - name: Build Android ARMHF
#       run: |
#         chmod a+x github/*.sh
#         bash github/github-build-android-armhf.sh
# 
#     - name: Upload artifacts
#       uses: actions/upload-artifact@v4
#       with:
#         name: android-armhf-package
#         path: build/*.tar.gz
#         if-no-files-found: warn
# 
#     - name: Deploy to Cloudsmith
#       if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
#       env:
#         CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
#         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#       run: |
#         sudo apt-get update
#         sudo apt-get install -y python3-pip 
#         python3 -m pip install cloudsmith-cli
#         bash ci/cloudsmith-upload.sh

# =============================================================================
# macOS Build
# =============================================================================
# build-macos-universal:
#   runs-on: macos-14
#   env:
#     OCPN_TARGET: macos
#     PKG_TARGET_WX_VER: "32"
#     CMAKE_BUILD_PARALLEL_LEVEL: 2
#     WX_VER: 32
#     MACOSX_DEPLOYMENT_TARGET: '10.10'
#   steps:
#     - name: Checkout code
#       uses: actions/checkout@v4
#       with:
#         submodules: recursive
#
#     - name: Cache dependencies
#       uses: actions/cache@v4
#       with:
#         path: |
#           /tmp/local.cache.tar
#           cache
#         key: macos-deps-${{ hashFiles('build-deps/macos-cache-stamp', 'cmake/MacosWxwidgets.cmake', 'ci/circleci-build-macos-universal.sh') }}
#         restore-keys: |
#           macos-deps-
#
#     - name: Build macOS Universal
#       run: |
#         chmod a+x ci/*.sh
#         chmod a+x cmake/*.sh
#         ci/circleci-build-macos-universal.sh
#
#     - name: Upload artifacts
#       uses: actions/upload-artifact@v4
#       with:
#         name: macos-universal-package
#         path: |
#           build/*.pkg
#           build/*.dmg
#           build/*.tar.gz
#         if-no-files-found: warn
#
#     - name: Deploy to Cloudsmith
#       if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
#       env:
#         CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
#         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#       run: |
#         python3 -m venv $HOME/cs-venv
#         source $HOME/cs-venv/bin/activate
#         pip install cloudsmith-cli
#         bash ci/cloudsmith-upload.sh

# =============================================================================
# Windows MSVC Build
# =============================================================================
 # build-msvc-wx32-2022:
 #   runs-on: windows-2022
 #   env:
 #     OCPN_TARGET: MSVC
 #     PKG_TARGET_WX_VER: "32"
 #     MSVC_VERSION: 2022
 #     WX_VER: 32
 #   steps:
 #     - name: Checkout code
 #       uses: actions/checkout@v4
 #       with:
 #         submodules: recursive
 #
 #     - name: Build MSVC
 #       shell: cmd
 #       run: ci\circleci-build-msvc.bat
 #
 #     - name: Upload artifacts
 #       uses: actions/upload-artifact@v4
 #       with:
 #         name: msvc-wx32-2022-package
 #         path: |
 #           build/*.exe
 #           build/*.tar.gz
 #         if-no-files-found: warn
 #
 #     - name: Deploy to Cloudsmith
 #       if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
 #       shell: bash
 #       env:
 #         CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
 #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
 #       run: |
 #         pip install cloudsmith-cli
 #         bash ci/cloudsmith-upload.sh

# =============================================================================
# Flatpak Builds
# =============================================================================
  build-flatpak-aarch64-2208:
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: flatpak
      BUILD_ARCH: aarch64
      FLATPAK_BRANCH: stable
      CLOUDSMITH_PKG_EXT: gz
      SDK_VER: 22.08
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
 
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
 
      - name: Build Flatpak ARM64
        run: |
          chmod a+x ci/*.sh
          bash ci/circleci-build-flatpak.sh
 
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-aarch64-2208-package
          path: build/*.tar.gz
          if-no-files-found: warn
 
      - name: Deploy to Cloudsmith
        if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip 
          python3 -m pip install cloudsmith-cli
          bash ci/cloudsmith-upload.sh

#build-flatpak-x86-2208:
#  runs-on: ubuntu-latest
#  env:
#    OCPN_TARGET: flatpak
#    BUILD_ARCH: x86_64
#    FLATPAK_BRANCH: stable
#    CLOUDSMITH_PKG_EXT: gz
#    SDK_VER: 22.08
#    WX_VER: 32
#  steps:
#    - name: Checkout code
#      uses: actions/checkout@v4
#      with:
#        submodules: recursive
#    - name: Install Flatpak dependencies
#      run: |
#        sudo apt-get update
#        sudo apt-get install -y bubblewrap flatpak flatpak-builder
#   
#    - name: Build Flatpak x86_64
#      run: |
#        chmod a+x ci/*.sh
#        bash ci/circleci-build-flatpak.sh
#
#    - name: Upload artifacts
#      uses: actions/upload-artifact@v4
#      with:
#        name: flatpak-x86-2208-package
#        path: build/*.tar.gz
#        if-no-files-found: warn
#
#    - name: Deploy to Cloudsmith
#      if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
#      env:
#        CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
#        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#      run: |
#        sudo apt-get update
#        sudo apt-get install -y python3-pip 
#        python3 -m pip install cloudsmith-cli
#        bash ci/cloudsmith-upload.sh

 #build-flatpak-aarch64-2408:
 #  runs-on: ubuntu-latest
 #  env:
 #    OCPN_TARGET: flatpak
 #    BUILD_ARCH: aarch64
 #    FLATPAK_BRANCH: stable
 #    CLOUDSMITH_PKG_EXT: gz
 #    SDK_VER: 24.08
 #  steps:
 #    - name: Checkout code
 #      uses: actions/checkout@v4
 #      with:
 #        submodules: recursive
 #
 #    - name: Set up QEMU
 #      uses: docker/setup-qemu-action@v3
 #      with:
 #        platforms: arm64
 #
 #    - name: Build Flatpak ARM64
 #      run: |
 #        chmod a+x ci/*.sh
 #        bash ci/circleci-build-flatpak.sh
 #
 #    - name: Upload artifacts
 #      uses: actions/upload-artifact@v4
 #      with:
 #        name: flatpak-aarch64-2408-package
 #        path: build/*.tar.gz
 #        if-no-files-found: warn
 #
 #    - name: Deploy to Cloudsmith
 #      if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
 #      env:
 #        CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
 #        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
 #      run: |
 #        sudo apt-get update
 #        sudo apt-get install -y python3-pip 
 #        python3 -m pip install cloudsmith-cli
 #        bash ci/cloudsmith-upload.sh

# build-flatpak-x86-2408:
#   runs-on: ubuntu-latest
#   env:
#     OCPN_TARGET: flatpak
#     BUILD_ARCH: x86_64
#     FLATPAK_BRANCH: stable
#     CLOUDSMITH_PKG_EXT: gz
#     SDK_VER: 24.08
#   steps:
#     - name: Checkout code
#       uses: actions/checkout@v4
#       with:
#         submodules: recursive
#
#     - name: Build Flatpak x86_64
#       run: |
#         chmod a+x ci/*.sh
#         bash ci/circleci-build-flatpak.sh
#
#     - name: Upload artifacts
#       uses: actions/upload-artifact@v4
#       with:
#         name: flatpak-x86-2408-package
#         path: build/*.tar.gz
#         if-no-files-found: warn
#
#     - name: Deploy to Cloudsmith
#       if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
#       env:
#         CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
#         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#       run: |
#         sudo apt-get update
#         sudo apt-get install -y python3-pip 
#         python3 -m pip install cloudsmith-cli
#         bash ci/cloudsmith-upload.sh

# =============================================================================
# Debian Builds
# =============================================================================
# build-debian-x86_64-13-trixie:
#   runs-on: ubuntu-latest
#   env:
#     OCPN_TARGET: trixie
#     PKG_BUILD_GTK: gtk3
#     PKG_TARGET_WX_VER: "32"
#     BUILD_GTK3: true
#     WX_VER: 32
#     BUILD_ENV: debian
#     DOCKER_IMAGE: debian:trixie
#     DOCKER_EXEC_NO_TTY: 1
#   steps:
#     - name: Checkout code
#       uses: actions/checkout@v4
#       with:
#         submodules: recursive
#     - name: Build Debian Trixie x86_64
#       run: |
#         chmod a+x github/*.sh
#         github/github-build-ubuntu-docker.sh
#     - name: Upload artifacts
#       uses: actions/upload-artifact@v4
#       with:
#         name: debian-trixie-x86_64-package
#         path: build/*.tar.gz
#         if-no-files-found: warn
#     - name: Deploy to Cloudsmith
#       if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
#       env:
#         CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
#         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#       run: |
#         sudo apt-get update
#         sudo apt-get install -y python3-pip 
#         python3 -m pip install cloudsmith-cli
#         bash ci/cloudsmith-upload.sh
#
# build-debian-arm64-13-trixie:
#   runs-on: ubuntu-latest
#   env:
#     OCPN_TARGET: trixie-arm64
#     PKG_BUILD_GTK: gtk3
#     PKG_TARGET_WX_VER: "32"
#     DOCKER_IMAGE: debian:trixie
#     BUILD_FLAGS: -j3
#     BUILD_ENV: debian
#     WX_VER: 32
#     BUILD_GTK3: true
#     DOCKER_EXEC_NO_TTY: 1
#     USE_UNSTABLE_REPO: ON
#   steps:
#     - name: Checkout code
#       uses: actions/checkout@v4
#       with:
#         submodules: recursive
#         fetch-depth: 0 
#         clean: false
#     - name: Set up QEMU
#       uses: docker/setup-qemu-action@v3
#       with:
#         platforms: arm64
#     - name: Build Debian Trixie ARM64
#       run: |
#         chmod a+x github/*.sh
#         github/github-build-ubuntu-docker.sh
#     - name: Upload artifacts
#       uses: actions/upload-artifact@v4
#       with:
#         name: debian-trixie-arm64-package
#         path: build/*.tar.gz
#         if-no-files-found: warn
#     - name: Deploy to Cloudsmith
#       if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
#       env:
#         CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
#         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#       run: |
#         sudo apt-get update
#         sudo apt-get install -y python3-pip 
#         python3 -m pip install cloudsmith-cli
#         bash ci/cloudsmith-upload.sh
#
# build-debian-armhf-13-trixie:
#   runs-on: ubuntu-latest
#