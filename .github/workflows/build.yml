name: Build OpenCPN Plugin

on:
  push:
    branches:
      - '*'
      - '!devel'
      - '!tmp'
    tags:
      - '*'
  pull_request:
    branches:
      - '*'
  workflow_dispatch:
    inputs:
      build_android_arm64:
        description: 'Build Android ARM64'
        required: false
        type: boolean
        default: false
      build_android_armhf:
        description: 'Build Android ARMHF'
        required: false
        type: boolean
        default: false
      build_macos_universal:
        description: 'Build macOS Universal'
        required: false
        type: boolean
        default: false
      build_msvc_wx32_2022:
        description: 'Build Windows MSVC WX32 2022'
        required: false
        type: boolean
        default: true
      build_flatpak_aarch64_2208:
        description: 'Build Flatpak ARM64 22.08'
        required: false
        type: boolean
        default: false
      build_flatpak_x86_2208:
        description: 'Build Flatpak x86_64 22.08'
        required: false
        type: boolean
        default: false
      build_flatpak_aarch64_2408:
        description: 'Build Flatpak ARM64 24.08'
        required: false
        type: boolean
        default: false
      build_flatpak_x86_2408:
        description: 'Build Flatpak x86_64 24.08'
        required: false
        type: boolean
        default: false
      build_debian_x86_64_13_trixie:
        description: 'Build Debian 13 Trixie x86_64'
        required: false
        type: boolean
        default: false
      build_debian_arm64_13_trixie:
        description: 'Build Debian 13 Trixie ARM64'
        required: false
        type: boolean
        default: false
      build_debian_armhf_13_trixie:
        description: 'Build Debian 13 Trixie ARMHF'
        required: false
        type: boolean
        default: false
      build_debian_x86_64_12_bookworm:
        description: 'Build Debian 12 Bookworm x86_64'
        required: false
        type: boolean
        default: false
      build_debian_arm64_12_bookworm:
        description: 'Build Debian 12 Bookworm ARM64'
        required: false
        type: boolean
        default: false
      build_debian_armhf_12_bookworm:
        description: 'Build Debian 12 Bookworm ARMHF'
        required: false
        type: boolean
        default: false
      build_debian_x86_64_11_bullseye:
        description: 'Build Debian 11 Bullseye x86_64'
        required: false
        type: boolean
        default: false
      build_debian_arm64_11_bullseye:
        description: 'Build Debian 11 Bullseye ARM64'
        required: false
        type: boolean
        default: false
      build_debian_armhf_11_bullseye:
        description: 'Build Debian 11 Bullseye ARMHF'
        required: false
        type: boolean
        default: false
      build_ubuntu_x86_64_2204_jammy:
        description: 'Build Ubuntu 22.04 Jammy x86_64'
        required: false
        type: boolean
        default: false

env:
  CLOUDSMITH_USER: opencpn
  USE_UNSTABLE_REPO: OFF

jobs:
# =============================================================================
# Android Builds
# =============================================================================
  build-android-arm64:
    if: github.event.inputs.build_android_arm64 == 'true'
    runs-on: ubuntu-latest
    container:
      image: cimg/android:2023.12-ndk
    env:
      OCPN_TARGET: android-arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build Android ARM64
        shell: bash
        run: |
          chmod a+x github/*.sh
          bash github/github-build-android-arm64.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-arm64-package
          path: build/*.tar.gz
          if-no-files-found: warn

      - name: Deploy to Cloudsmith
        if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip 
          python3 -m pip install cloudsmith-cli
          export PATH="$HOME/.local/bin:$PATH"
          bash ci/cloudsmith-upload.sh

  build-android-armhf:
    if: github.event.inputs.build_android_armhf == 'true'
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: android-armhf
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
  
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip wget
  
      - name: Install Android NDK r21e (required for ARMHF)
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r21e-linux-x86_64.zip
          unzip android-ndk-r21e-linux-x86_64.zip
          sudo mv android-ndk-r21e /opt/android-ndk
  
          sudo mkdir -p /opt/android
          sudo ln -s /opt/android-ndk /opt/android/ndk
  
          echo "ANDROID_NDK_HOME=/opt/android-ndk" >> $GITHUB_ENV
          echo "ANDROID_NDK=/opt/android-ndk" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=/opt/android-ndk" >> $GITHUB_ENV
 
      - name: Build Android ARMHF
        run: |
          chmod a+x github/*.sh
          bash github/github-build-android-armhf.sh
  
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-armhf-package
          path: build/*.tar.gz
          if-no-files-found: warn
  
      - name: Deploy to Cloudsmith
        if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip 
          python3 -m pip install cloudsmith-cli
          export PATH="$HOME/.local/bin:$PATH"
          bash ci/cloudsmith-upload.sh

# =============================================================================
# macOS Build
# =============================================================================
  build-macos-universal:
    if: github.event.inputs.build_macos_universal == 'true'
    runs-on: macos-14
    env:
      OCPN_TARGET: macos
      PKG_TARGET_WX_VER: "32"
      CMAKE_BUILD_PARALLEL_LEVEL: 2
      WX_VER: 32
      MACOSX_DEPLOYMENT_TARGET: '10.10'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            /tmp/local.cache.tar
            cache
          key: macos-deps-${{ hashFiles('build-deps/macos-cache-stamp', 'cmake/MacosWxwidgets.cmake', 'ci/circleci-build-macos-universal.sh') }}
          restore-keys: |
            macos-deps-

      - name: Build macOS Universal
        run: |
          chmod a+x ci/*.sh
          chmod a+x cmake/*.sh
          ci/circleci-build-macos-universal.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal-package
          path: |
            build/*.pkg
            build/*.dmg
            build/*.tar.gz
          if-no-files-found: warn

      - name: Deploy to Cloudsmith
        if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 -m venv $HOME/cs-venv
          source $HOME/cs-venv/bin/activate
          pip install cloudsmith-cli
          bash ci/cloudsmith-upload.sh

# =============================================================================
# Windows MSVC Build
# =============================================================================
  build-msvc-wx32-2022:
    if: github.event.inputs.build_msvc_wx32_2022 == 'true'
    runs-on: windows-2022
    env:
      OCPN_TARGET: MSVC
      PKG_TARGET_WX_VER: "32"
      MSVC_VERSION: 2022
      WX_VER: 32
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build MSVC
        shell: cmd
        run: ci\circleci-build-msvc.bat

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: msvc-wx32-2022-package
          path: |
            build/*.exe
            build/*.tar.gz
          if-no-files-found: warn

      - name: Deploy to Cloudsmith
        if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
        shell: bash
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pip install cloudsmith-cli
          bash ci/cloudsmith-upload.sh

# =============================================================================
# Flatpak Builds
# =============================================================================
  build-flatpak-aarch64-2208:
    if: github.event.inputs.build_flatpak_aarch64_2208 == 'true'
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: flatpak
      BUILD_ARCH: aarch64
      FLATPAK_BRANCH: stable
      CLOUDSMITH_PKG_EXT: gz
      SDK_VER: 22.08
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
 
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
 
      - name: Build Flatpak ARM64
        run: |
          chmod a+x ci/*.sh
          bash ci/circleci-build-flatpak.sh
 
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-aarch64-2208-package
          path: build/*.tar.gz
          if-no-files-found: warn
 
      - name: Deploy to Cloudsmith
        if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip 
          python3 -m pip install cloudsmith-cli
          bash ci/cloudsmith-upload.sh

  build-flatpak-x86-2208:
    if: github.event.inputs.build_flatpak_x86_2208 == 'true'
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: flatpak
      BUILD_ARCH: x86_64
      FLATPAK_BRANCH: stable
      CLOUDSMITH_PKG_EXT: gz
      SDK_VER: 22.08
      WX_VER: 32
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Install Flatpak dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bubblewrap flatpak flatpak-builder
     
      - name: Build Flatpak x86_64
        run: |
          chmod a+x ci/*.sh
          bash ci/circleci-build-flatpak.sh
  
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-x86-2208-package
          path: build/*.tar.gz
          if-no-files-found: warn
  
      - name: Deploy to Cloudsmith
        if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip 
          python3 -m pip install cloudsmith-cli
          bash ci/cloudsmith-upload.sh

  build-flatpak-aarch64-2408:
    if: github.event.inputs.build_flatpak_aarch64_2408 == 'true'
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: flatpak
      BUILD_ARCH: aarch64
      FLATPAK_BRANCH: stable
      CLOUDSMITH_PKG_EXT: gz
      SDK_VER: 24.08
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
  
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
  
      - name: Build Flatpak ARM64
        run: |
          chmod a+x ci/*.sh
          bash ci/circleci-build-flatpak.sh
  
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-aarch64-2408-package
          path: build/*.tar.gz
          if-no-files-found: warn
  
      - name: Deploy to Cloudsmith
        if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip 
          python3 -m pip install cloudsmith-cli
          bash ci/cloudsmith-upload.sh

  build-flatpak-x86-2408:
    if: github.event.inputs.build_flatpak_x86_2408 == 'true'
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: flatpak
      BUILD_ARCH: x86_64
      FLATPAK_BRANCH: stable
      CLOUDSMITH_PKG_EXT: gz
      SDK_VER: 24.08
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build Flatpak x86_64
        run: |
          chmod a+x ci/*.sh
          bash ci/circleci-build-flatpak.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-x86-2408-package
          path: build/*.tar.gz
          if-no-files-found: warn

      - name: Deploy to Cloudsmith
        if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip 
          python3 -m pip install cloudsmith-cli
          bash ci/cloudsmith-upload.sh

# =============================================================================
# Debian Builds
# =============================================================================

# ---------------------------------------------------------
# Debian 13 Trixie — x86_64
# ---------------------------------------------------------
  build-debian-x86_64-13-trixie:
    if: github.event.inputs.build_debian_x86_64_13_trixie == 'true'
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: trixie
      BUILD_ARCH: amd64
      BUILD_GTK3: true
      WX_VER: 32
      BUILD_ENV: debian
      DOCKER_IMAGE: debian:trixie
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
 
      - name: Build Debian Trixie x86_64
        run: |
          chmod a+x github/*.sh
          github/github-build-ubuntu-docker.sh
 
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debian-trixie-x86_64-package
          path: build/*.tar.gz
          if-no-files-found: warn
 
      - name: Deploy to Cloudsmith
        if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip jq
          python3 -m pip install --user cloudsmith-cli
          export PATH="$HOME/.local/bin:$PATH"
          bash ci/cloudsmith-upload.sh
 
# ---------------------------------------------------------
# Debian 13 Trixie — ARM64
# ---------------------------------------------------------
  build-debian-arm64-13-trixie:
    if: github.event.inputs.build_debian_arm64_13_trixie == 'true'
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: trixie-arm64
      BUILD_ARCH: arm64
      DOCKER_IMAGE: arm64v8/debian:trixie
      BUILD_FLAGS: -j3
      BUILD_ENV: debian
      WX_VER: 32
      BUILD_GTK3: true
      USE_UNSTABLE_REPO: ON
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive  
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64  
      - name: Build Debian Trixie ARM64
        run: |
          chmod a+x github/*.sh
          github/github-build-ubuntu-docker.sh  
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debian-trixie-arm64-package
          path: build/*.tar.gz
          if-no-files-found: warn  
      - name: Deploy to Cloudsmith
        if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BUILD_DIR: build 
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip jq
          python3 -m pip install cloudsmith-cli
          export PATH="$HOME/.local/bin:$PATH"
          bash ci/cloudsmith-upload.sh

# ---------------------------------------------------------
# Debian 13 Trixie — ARMHF
# ---------------------------------------------------------
  build-debian-armhf-13-trixie:
    if: github.event.inputs.build_debian_armhf_13_trixie == 'true'
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: trixie-armhf
      BUILD_ARCH: armhf
      DOCKER_IMAGE: arm32v7/debian:trixie
      BUILD_FLAGS: -j3
      BUILD_ENV: debian
      WX_VER: 32
      BUILD_GTK3: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm

      - name: Build Debian Trixie ARMHF
        run: |
          chmod a+x github/*.sh
          github/github-build-ubuntu-docker.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debian-trixie-armhf-package
          path: build/*.tar.gz
          if-no-files-found: warn

      - name: Deploy to Cloudsmith
        if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip jq
          python3 -m pip install --user cloudsmith-cli
          export PATH="$HOME/.local/bin:$PATH"
          bash ci/cloudsmith-upload.sh

# ---------------------------------------------------------
# Debian 12 Bookworm — x86_64
# ---------------------------------------------------------
  build-debian-x86_64-12-bookworm:
    if: github.event.inputs.build_debian_x86_64_12_bookworm == 'true'
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: bookworm
      BUILD_ARCH: amd64
      BUILD_GTK3: true
      WX_VER: 32
      BUILD_ENV: debian
      DOCKER_IMAGE: debian:bookworm
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build Debian Bookworm x86_64
        run: |
          chmod a+x github/*.sh
          github/github-build-ubuntu-docker.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debian-bookworm-x86_64-package
          path: build/*.tar.gz
          if-no-files-found: warn

      - name: Deploy to Cloudsmith
        if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip jq
          python3 -m pip install --user cloudsmith-cli
          export PATH="$HOME/.local/bin:$PATH"
          bash ci/cloudsmith-upload.sh

# ---------------------------------------------------------
# Debian 12 Bookworm — ARM64
# ---------------------------------------------------------
  build-debian-arm64-12-bookworm:
    if: github.event.inputs.build_debian_arm64_12_bookworm == 'true'
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: bookworm-arm64
      BUILD_ARCH: arm64
      DOCKER_IMAGE: arm64v8/debian:bookworm
      BUILD_FLAGS: -j3
      BUILD_ENV: debian
      WX_VER: 32
      BUILD_GTK3: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build Debian Bookworm ARM64
        run: |
          chmod a+x github/*.sh
          github/github-build-ubuntu-docker.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debian-bookworm-arm64-package
          path: build/*.tar.gz
          if-no-files-found: warn

      - name: Deploy to Cloudsmith
        if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip jq
          python3 -m pip install --user cloudsmith-cli
          export PATH="$HOME/.local/bin:$PATH"
          bash ci/cloudsmith-upload.sh

# ---------------------------------------------------------
# Debian 12 Bookworm — ARMHF
# ---------------------------------------------------------
  build-debian-armhf-12-bookworm:
    if: github.event.inputs.build_debian_armhf_12_bookworm == 'true'
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: bookworm-armhf
      BUILD_ARCH: armhf
      DOCKER_IMAGE: arm32v7/debian:bookworm
      BUILD_FLAGS: -j3
      BUILD_ENV: debian
      WX_VER: 32
      BUILD_GTK3: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm

      - name: Build Debian Bookworm ARMHF
        run: |
          chmod a+x github/*.sh
          github/github-build-ubuntu-docker.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debian-bookworm-armhf-package
          path: build/*.tar.gz
          if-no-files-found: warn

      - name: Deploy to Cloudsmith
        if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip jq
          python3 -m pip install --user cloudsmith-cli
          export PATH="$HOME/.local/bin:$PATH"
          bash ci/cloudsmith-upload.sh

# ---------------------------------------------------------
# Debian 11 Bullseye — x86_64
# ---------------------------------------------------------
  build-debian-x86_64-11-bullseye:
    if: github.event.inputs.build_debian_x86_64_11_bullseye == 'true'
    runs-on: ubuntu-22.04
    container:
      image: buildpack-deps:bullseye-scm
    env:
      OCPN_TARGET: bullseye
      BUILD_ARCH: amd64
      BUILD_GTK3: true
      BUILD_ENV: debian
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup apt sources
        run: |
          echo "deb-src http://ftp.us.debian.org/debian bullseye main" | tee -a /etc/apt/sources.list
          echo "deb-src http://ftp.us.debian.org/debian bullseye-updates main" | tee -a /etc/apt/sources.list

      - name: Build Debian Bullseye x86_64
        run: |
          chmod a+x github/*.sh
          github/github-build-ubuntu-docker.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debian-bullseye-x86_64-package
          path: build/*.tar.gz
          if-no-files-found: warn

      - name: Deploy to Cloudsmith
        if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          apt-get update
          apt-get install -y python3-pip jq
          python3 -m pip install --user cloudsmith-cli
          export PATH="$HOME/.local/bin:$PATH"
          bash ci/cloudsmith-upload.sh

# ---------------------------------------------------------
# Debian 11 Bullseye — ARM64
# ---------------------------------------------------------
  build-debian-arm64-11-bullseye:
    if: github.event.inputs.build_debian_arm64_11_bullseye == 'true'
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: bullseye-arm64
      BUILD_ARCH: arm64
      DOCKER_IMAGE: arm64v8/debian:bullseye-backports
      BUILD_FLAGS: -j3
      BUILD_ENV: debian
      BUILD_GTK3: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build Debian Bullseye ARM64
        run: |
          chmod a+x github/*.sh
          github/github-build-ubuntu-docker.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debian-bullseye-arm64-package
          path: build/*.tar.gz
          if-no-files-found: warn

      - name: Deploy to Cloudsmith
        if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip jq
          python3 -m pip install --user cloudsmith-cli
          export PATH="$HOME/.local/bin:$PATH"
          bash ci/cloudsmith-upload.sh

# ---------------------------------------------------------
# Debian 11 Bullseye — ARMHF
# ---------------------------------------------------------
  build-debian-armhf-11-bullseye:
    if: github.event.inputs.build_debian_armhf_11_bullseye == 'true'
    runs-on: ubuntu-latest
    env:
      OCPN_TARGET: bullseye-armhf
      BUILD_ARCH: armhf
      DOCKER_IMAGE: jongough/debian-armhf:bullseye
      BUILD_FLAGS: -j3
      BUILD_ENV: debian
      BUILD_GTK3: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm

      - name: Build Debian Bullseye ARMHF
        run: |
          chmod a+x github/*.sh
          github/github-build-ubuntu-docker.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debian-bullseye-armhf-package
          path: build/*.tar.gz
          if-no-files-found: warn

      - name: Deploy to Cloudsmith
        if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip jq
          python3 -m pip install --user cloudsmith-cli
          export PATH="$HOME/.local/bin:$PATH"
          bash ci/cloudsmith-upload.sh

# =============================================================================
# Ubuntu Builds
# =============================================================================
  build-ubuntu-x86_64-2204-jammy:
    if: github.event.inputs.build_ubuntu_x86_64_2204_jammy == 'true'
    runs-on: ubuntu-22.04
    env:
      BUILD_GTK3: true
      OCPN_TARGET: jammy
      WX_VER: 32
      BUILD_ENV: ubuntu

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Update apt sources
        run: |
          echo "deb-src http://us.archive.ubuntu.com/ubuntu/ jammy main" | sudo tee -a /etc/apt/sources.list
          echo "deb-src http://us.archive.ubuntu.com/ubuntu/ jammy-updates main" | sudo tee -a /etc/apt/sources.list
          echo "deb [trusted=yes] https://ppa.launchpadcontent.net/opencpn/opencpn/ubuntu/ jammy main" | sudo tee -a /etc/apt/sources.list
          sudo apt-get update

      - name: Build Ubuntu Jammy x86_64
        run: |
          chmod a+x ci/*.sh
          ci/circleci-build-debian.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-jammy-x86_64-package
          path: build/*.tar.gz
          if-no-files-found: warn

      - name: Deploy to Cloudsmith
        if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/master')
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip jq
          python3 -m pip install --upgrade pip
          python3 -m pip install --upgrade cloudsmith-cli
          bash ci/cloudsmith-upload.sh