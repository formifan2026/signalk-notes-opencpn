---
name: Build SignalK Notes Plugin

on:
  push:
    branches:
      - master
      - main
    tags:
      - v*
  pull_request:
    branches:
      - master
      - main

env:
  CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
  CLOUDSMITH_UNSTABLE_REPO: ${{ secrets.CLOUDSMITH_UNSTABLE_REPO }}
  CLOUDSMITH_STABLE_REPO: ${{ secrets.CLOUDSMITH_STABLE_REPO }}
  CLOUDSMITH_BETA_REPO: ${{ secrets.CLOUDSMITH_BETA_REPO }}

jobs:
  build-ubuntu-docker:
    runs-on: ubuntu-20.04
    env:
      OCPN_TARGET: ubuntu-gtk3
      CMAKE_BUILD_PARALLEL_LEVEL: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: 'recursive'

      - name: Build Ubuntu
        run: bash ci/circleci-build-ubuntu-docker.sh

      - name: Upload artifacts
        if: github.event_name == 'push'
        run: |
          if [ -f build/upload.sh ]; then
            cd build && bash upload.sh
          fi

  build-debian:
    runs-on: ubuntu-20.04
    env:
      OCPN_TARGET: debian-x86_64
      CMAKE_BUILD_PARALLEL_LEVEL: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: 'recursive'

      - name: Build Debian
        run: bash ci/circleci-build-debian.sh

      - name: Upload artifacts
        if: github.event_name == 'push'
        run: |
          if [ -f build/upload.sh ]; then
            cd build && bash upload.sh
          fi

#  build-jammy:
#    runs-on: ubuntu-22.04
#    env:
#      OCPN_TARGET: jammy
#      CMAKE_BUILD_PARALLEL_LEVEL: 2
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v3
#        with:
#          submodules: 'recursive'
#
#      - name: Build Jammy
#        run: bash ci/circleci-build-jammy.sh
#
#      - name: Upload artifacts
#        if: github.event_name == 'push'
#        run: |
#          if [ -f build/upload.sh ]; then
#            cd build && bash upload.sh
#          fi

  build-flatpak:
    runs-on: ubuntu-20.04
    env:
      OCPN_TARGET: flatpak-x86_64
      CMAKE_BUILD_PARALLEL_LEVEL: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: 'recursive'

      - name: Build Flatpak
        run: bash ci/circleci-build-flatpak.sh

      - name: Upload artifacts
        if: github.event_name == 'push'
        run: |
          if [ -f build/upload.sh ]; then
            cd build && bash upload.sh
          fi

  build-macos:
    runs-on: macos-11
    env:
      OCPN_TARGET: macos
      CMAKE_BUILD_PARALLEL_LEVEL: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: 'recursive'

      - name: Build macOS
        run: bash ci/circleci-build-macos.sh

      - name: Upload artifacts
        if: github.event_name == 'push'
        run: |
          if [ -f build/upload.sh ]; then
            cd build && bash upload.sh
          fi

  build-macos-universal:
    runs-on: macos-11
    env:
      OCPN_TARGET: macos-universal
      CMAKE_BUILD_PARALLEL_LEVEL: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: 'recursive'

      - name: Build macOS Universal
        run: bash ci/circleci-build-macos-universal.sh

      - name: Upload artifacts
        if: github.event_name == 'push'
        run: |
          if [ -f build/upload.sh ]; then
            cd build && bash upload.sh
          fi

  build-msvc:
    runs-on: windows-2022
    env:
      OCPN_TARGET: msvc-wx32
    steps:
      - name: Checkout Plugin
        uses: actions/checkout@v4

      - name: Checkout OpenCPN Core (Dependencies)
        uses: actions/checkout@v4
        with:
          repository: OpenCPN/OpenCPN
          path: opencpn-core
          ref: master # Oder ein spezifischer Release-Tag wie v5.10.0

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Dependencies
        working-directory: opencpn-core
        run: |
          # Nutzt das moderne Skript statt des alten 4.99a Archivs
          .\buildwin\win_deps.bat
          
      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake -A Win32 `
            -DwxWidgets_ROOT_DIR="${{ github.workspace }}\opencpn-core\cache\buildwin\wxWidgets-3.2.2.1" `
            -DwxWidgets_LIB_DIR="${{ github.workspace }}\opencpn-core\cache\buildwin\wxWidgets-3.2.2.1\lib\vc14x_dll" `
            -DwxWidgets_CONFIGURATION=mswunivd `
            -DwxWidgets_USING_DLL=ON `
            -DwxWidgets_SELECT_LIBRARIES=core,base,net,xml,html,adv,aui,gl `
            ..

      - name: Build Plugin
        working-directory: build
        run: cmake --build . --config Release
  

  build-android-arm64:
    runs-on: ubuntu-20.04
    env:
      OCPN_TARGET: android-arm64
      CMAKE_BUILD_PARALLEL_LEVEL: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: 'recursive'

      - name: Build Android ARM64
        run: bash ci/circleci-build-android-arm64.sh

      - name: Upload artifacts
        if: github.event_name == 'push'
        run: |
          if [ -f build/upload.sh ]; then
            cd build && bash upload.sh
          fi

  build-android-armhf:
    runs-on: ubuntu-20.04
    env:
      OCPN_TARGET: android-armhf
      CMAKE_BUILD_PARALLEL_LEVEL: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: 'recursive'

      - name: Build Android ARMHF
        run: bash ci/circleci-build-android-armhf.sh

      - name: Upload artifacts
        if: github.event_name == 'push'
        run: |
          if [ -f build/upload.sh ]; then
            cd build && bash upload.sh
          fi