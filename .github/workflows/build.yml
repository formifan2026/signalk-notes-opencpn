---
name: Build SignalK Notes Plugin

on:
  push:
    branches:
      - master
      - main
    tags:
      - v*
  pull_request:
    branches:
      - master
      - main

env:
  CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
  CLOUDSMITH_UNSTABLE_REPO: ${{ secrets.CLOUDSMITH_UNSTABLE_REPO }}
  CLOUDSMITH_STABLE_REPO: ${{ secrets.CLOUDSMITH_STABLE_REPO }}
  CLOUDSMITH_BETA_REPO: ${{ secrets.CLOUDSMITH_BETA_REPO }}

jobs:
  build-ubuntu-docker:
    runs-on: ubuntu-20.04
    env:
      OCPN_TARGET: ubuntu-gtk3
      CMAKE_BUILD_PARALLEL_LEVEL: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Build Ubuntu
        run: bash ci/circleci-build-ubuntu-docker.sh

      - name: Upload artifacts
        if: github.event_name == 'push'
        run: |
          if [ -f build/upload.sh ]; then
            cd build && bash upload.sh
          fi

  build-debian:
    runs-on: ubuntu-20.04
    env:
      OCPN_TARGET: debian-x86_64
      CMAKE_BUILD_PARALLEL_LEVEL: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Build Debian
        run: bash ci/circleci-build-debian.sh

      - name: Upload artifacts
        if: github.event_name == 'push'
        run: |
          if [ -f build/upload.sh ]; then
            cd build && bash upload.sh
          fi

  build-flatpak:
    runs-on: ubuntu-20.04
    env:
      OCPN_TARGET: flatpak-x86_64
      CMAKE_BUILD_PARALLEL_LEVEL: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Build Flatpak
        run: bash ci/circleci-build-flatpak.sh

      - name: Upload artifacts
        if: github.event_name == 'push'
        run: |
          if [ -f build/upload.sh ]; then
            cd build && bash upload.sh
          fi

  build-macos:
    runs-on: macos-11
    env:
      OCPN_TARGET: macos
      CMAKE_BUILD_PARALLEL_LEVEL: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Build macOS
        run: bash ci/circleci-build-macos.sh

      - name: Upload artifacts
        if: github.event_name == 'push'
        run: |
          if [ -f build/upload.sh ]; then
            cd build && bash upload.sh
          fi

  build-macos-universal:
    runs-on: macos-11
    env:
      OCPN_TARGET: macos-universal
      CMAKE_BUILD_PARALLEL_LEVEL: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Build macOS Universal
        run: bash ci/circleci-build-macos-universal.sh

      - name: Upload artifacts
        if: github.event_name == 'push'
        run: |
          if [ -f build/upload.sh ]; then
            cd build && bash upload.sh
          fi

  build-msvc:
    runs-on: windows-2022
    env:
      OCPN_TARGET: msvc-wx32
      CMAKE_BUILD_PARALLEL_LEVEL: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v1.1

      - name: Setup MSVC Environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x86

      - name: Cache wxWidgets
        id: cache-wx
        uses: actions/cache@v3
        with:
          path: C:\wxWidgets-3.2.2.1
          key: wxWidgets-3.2.2.1-msvc-x86-v3

      - name: Install Dependencies
        shell: pwsh
        run: |
          choco install -y python --version=3.11.0
          choco install -y gettext
          refreshenv
          python -m pip install --upgrade pip
          python -m pip install cloudsmith-cli
          python -m pip install cryptography

      - name: Download and Install wxWidgets
        if: steps.cache-wx.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $wx_version = "3.2.2.1"
          $wx_source_url = "https://github.com/wxWidgets/wxWidgets/releases/download/v$wx_version/wxWidgets-$wx_version.7z"
          $wx_headers_url = "https://github.com/wxWidgets/wxWidgets/releases/download/v$wx_version/wxWidgets-$wx_version-headers.7z"
          
          Write-Host "Downloading wxWidgets..."
          curl.exe -L -o wxWidgets-source.7z $wx_source_url
          curl.exe -L -o wxWidgets-headers.7z $wx_headers_url
          
          $sourceSize = (Get-Item wxWidgets-source.7z).Length
          $headerSize = (Get-Item wxWidgets-headers.7z).Length
          
          if ($sourceSize -lt 10000000 -or $headerSize -lt 1000000) {
            Write-Error "Download failed"
            exit 1
          }
          
          New-Item -Path "C:\wxWidgets-3.2.2.1" -ItemType Directory -Force
          7z x wxWidgets-source.7z -o"C:\wxWidgets-3.2.2.1" -y
          7z x wxWidgets-headers.7z -o"C:\wxWidgets-3.2.2.1" -y
          
          cd "C:\wxWidgets-3.2.2.1\build\msw"
          nmake /f makefile.vc BUILD=release SHARED=1 RUNTIME_LIBS=dynamic COMPILER_VERSION=143 VENDOR=custom

      - name: Download OpenCPN Dependencies
        shell: pwsh
        run: |
          curl.exe -L -o opencpn.lib https://sourceforge.net/projects/opencpnplugins/files/opencpn.lib/download
          curl.exe -L -o nsis-setup.exe https://download.opencpn.org/s/54HsBDLNzRZLL6i/download/nsis-3.04-setup.exe
          Start-Process -FilePath "nsis-setup.exe" -ArgumentList "/S" -Wait

      - name: Determine wxWidgets Lib Directory
        id: wx-lib-dir
        shell: pwsh
        run: |
          $possibleDirs = @(
            "C:\wxWidgets-3.2.2.1\lib\vc14x_dll",
            "C:\wxWidgets-3.2.2.1\lib\vc143_dll",
            "C:\wxWidgets-3.2.2.1\lib\vc_dll"
          )
          
          foreach ($dir in $possibleDirs) {
            if (Test-Path $dir) {
              echo "WX_LIB_DIR=$dir" >> $env:GITHUB_OUTPUT
              exit 0
            }
          }
          
          $foundDir = Get-ChildItem "C:\wxWidgets-3.2.2.1\lib" -Directory | Select-Object -First 1
          if ($foundDir) {
            echo "WX_LIB_DIR=$($foundDir.FullName)" >> $env:GITHUB_OUTPUT
          } else {
            Write-Error "No wxWidgets lib directory found"
            exit 1
          }

      - name: Configure CMake
        shell: pwsh
        run: |
          New-Item -Path "build" -ItemType Directory -Force
          cd build
          
          $wxLibDir = "${{ steps.wx-lib-dir.outputs.WX_LIB_DIR }}"
          
          cmake -A Win32 -G "Visual Studio 17 2022" `
            -DCMAKE_BUILD_TYPE=Release `
            -DwxWidgets_ROOT_DIR="C:\wxWidgets-3.2.2.1" `
            -DwxWidgets_LIB_DIR="$wxLibDir" `
            ..

      - name: Build
        working-directory: build
        run: cmake --build . --config Release --target package

      - name: Upload to Cloudsmith
        if: github.event_name == 'push'
        shell: bash
        run: |
          if [ -f build/upload.sh ]; then
            cd build
            bash upload.sh
          fi

  build-android-armhf:
    runs-on: ubuntu-20.04
    env:
      OCPN_TARGET: android-armhf
      CMAKE_BUILD_PARALLEL_LEVEL: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Build Android ARMHF
        run: bash ci/circleci-build-android-armhf.sh

      - name: Upload artifacts
        if: github.event_name == 'push'
        run: |
          if [ -f build/upload.sh ]; then
            cd build && bash upload.sh
          fi