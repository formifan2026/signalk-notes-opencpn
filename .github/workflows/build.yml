---
name: Build SignalK Notes Plugin

on:
  push:
    branches:
      - master
      - main
    tags:
      - v*
  pull_request:
    branches:
      - master
      - main

env:
  CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
  CLOUDSMITH_UNSTABLE_REPO: ${{ secrets.CLOUDSMITH_UNSTABLE_REPO }}
  CLOUDSMITH_STABLE_REPO: ${{ secrets.CLOUDSMITH_STABLE_REPO }}
  CLOUDSMITH_BETA_REPO: ${{ secrets.CLOUDSMITH_BETA_REPO }}

jobs:
  build-ubuntu-docker:
    runs-on: ubuntu-20.04
    env:
      OCPN_TARGET: ubuntu-gtk3
      CMAKE_BUILD_PARALLEL_LEVEL: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Build Ubuntu
        run: bash ci/circleci-build-ubuntu-docker.sh

      - name: Upload artifacts
        if: github.event_name == 'push'
        run: |
          if [ -f build/upload.sh ]; then
            cd build && bash upload.sh
          fi

  build-debian:
    runs-on: ubuntu-20.04
    env:
      OCPN_TARGET: debian-x86_64
      CMAKE_BUILD_PARALLEL_LEVEL: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Build Debian
        run: bash ci/circleci-build-debian.sh

      - name: Upload artifacts
        if: github.event_name == 'push'
        run: |
          if [ -f build/upload.sh ]; then
            cd build && bash upload.sh
          fi

  build-flatpak:
    runs-on: ubuntu-20.04
    env:
      OCPN_TARGET: flatpak-x86_64
      CMAKE_BUILD_PARALLEL_LEVEL: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Build Flatpak
        run: bash ci/circleci-build-flatpak.sh

      - name: Upload artifacts
        if: github.event_name == 'push'
        run: |
          if [ -f build/upload.sh ]; then
            cd build && bash upload.sh
          fi

  build-macos:
    runs-on: macos-11
    env:
      OCPN_TARGET: macos
      CMAKE_BUILD_PARALLEL_LEVEL: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Build macOS
        run: bash ci/circleci-build-macos.sh

      - name: Upload artifacts
        if: github.event_name == 'push'
        run: |
          if [ -f build/upload.sh ]; then
            cd build && bash upload.sh
          fi

  build-macos-universal:
    runs-on: macos-11
    env:
      OCPN_TARGET: macos-universal
      CMAKE_BUILD_PARALLEL_LEVEL: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Build macOS Universal
        run: bash ci/circleci-build-macos-universal.sh

      - name: Upload artifacts
        if: github.event_name == 'push'
        run: |
          if [ -f build/upload.sh ]; then
            cd build && bash upload.sh
          fi

  build-msvc:
    runs-on: windows-2022
    env:
      OCPN_TARGET: msvc-wx32
      CMAKE_BUILD_PARALLEL_LEVEL: 2

    steps:
      - name: Checkout Plugin
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v1.1

      - name: Setup MSVC Environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x86

      - name: Cache wxWidgets
        id: cache-wx
        uses: actions/cache@v3
        with:
          path: C:\wxWidgets-3.2.2
          key: wxWidgets-3.2.2-vc14x-dev

      - name: Download wxWidgets 3.2.2 Dev + Headers
        if: steps.cache-wx.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $headers = "https://github.com/wxWidgets/wxWidgets/releases/download/v3.2.2/wxWidgets-3.2.2_Headers.7z"
          $dev     = "https://github.com/wxWidgets/wxWidgets/releases/download/v3.2.2/wxMSW-3.2.2_vc14x_Dev.7z"
      
          Write-Host "Downloading wxWidgets headers..."
          curl.exe -L -o wxHeaders.7z $headers
      
          Write-Host "Downloading wxWidgets MSVC Dev package..."
          curl.exe -L -o wxDev.7z $dev
      
          # Zielordner neu anlegen
          Remove-Item -Recurse -Force "C:\wxWidgets-3.2.2" -ErrorAction SilentlyContinue
          New-Item -Path "C:\wxWidgets-3.2.2" -ItemType Directory -Force
      
          # Beide Archive in denselben Ordner extrahieren
          7z x wxHeaders.7z -o"C:\wxWidgets-3.2.2" -y
          7z x wxDev.7z     -o"C:\wxWidgets-3.2.2" -y
      
          # Debug-Ausgabe
          Write-Host "wxWidgets include dir:"
          Get-ChildItem "C:\wxWidgets-3.2.2\include\wx" | Select-Object -First 10
      
          Write-Host "wxWidgets lib dir:"
          Get-ChildItem "C:\wxWidgets-3.2.2\lib\vc14x_dll" | Select-Object -First 10

      - name: Install Dependencies (Python, Cloudsmith, Gettext)
        shell: pwsh
        run: |
          choco install -y python --version=3.11.0
          choco install -y gettext
          refreshenv
          python -m pip install --upgrade pip
          python -m pip install cloudsmith-cli cryptography

      - name: Download OpenCPN Dependencies
        shell: pwsh
        run: |
          curl.exe -L -o opencpn.lib https://sourceforge.net/projects/opencpnplugins/files/opencpn.lib/download
          curl.exe -L -o nsis-setup.exe https://download.opencpn.org/s/54HsBDLNzRZLL6i/download/nsis-3.04-setup.exe
          Start-Process -FilePath "nsis-setup.exe" -ArgumentList "/S" -Wait

      - name: Configure CMake
        shell: pwsh
        run: |
          New-Item -Path "build" -ItemType Directory -Force
          cd build

          $wxRoot   = "C:\wxWidgets-3.2.2"
          $wxLibDir = "$wxRoot\lib\vc14x_dll"

           cmake -A Win32 -G "Visual Studio 17 2022" `
             "-DCMAKE_BUILD_TYPE=Release" `
             "-DwxWidgets_ROOT_DIR=$wxRoot" `
             "-DwxWidgets_LIB_DIR=$wxLibDir" `
             "-DwxWidgets_CONFIGURATION=mswu" `
             "-DwxWidgets_USING_DLL=ON" `
             "-DwxWidgets_SELECT_LIBRARIES=base;core;net;xml;html;adv;aui;gl" `
             ..
           
      - name: Build Plugin
        working-directory: build
        run: cmake --build . --config Release --target package

      - name: Upload to Cloudsmith
        if: github.event_name == 'push'
        shell: bash
        run: |
          if [ -f build/upload.sh ]; then
            cd build
            bash upload.sh
          fi

  build-android-armhf:
    runs-on: ubuntu-20.04
    env:
      OCPN_TARGET: android-armhf
      CMAKE_BUILD_PARALLEL_LEVEL: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Build Android ARMHF
        run: bash ci/circleci-build-android-armhf.sh

      - name: Upload artifacts
        if: github.event_name == 'push'
        run: |
          if [ -f build/upload.sh ]; then
            cd build && bash upload.sh
          fi